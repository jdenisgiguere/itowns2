<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Lyon (plane mode)</title>

    <style type="text/css">
            html {height: 100%}
        body { margin: 0; overflow:hidden; height:100%}

            #viewerDiv {
                margin : auto auto;
                width: 100%;
                height: 100%;
                padding: 0;
                /*margin-top: 50vh;
                transform: translateY(-50%);*/
            }
            #menuDiv {position: absolute; top:0px; margin-left: 0px;}


        </style>
        <meta charset="UTF-8">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.1/dat.gui.min.js"></script>
    </head>
    <body>
        <div id="viewerDiv"></div>
        <script src="/examples/GUI/GuiTools.js"></script>
        <script src="/dist/itowns.js"></script>
        <script src="/dist/debug.js"></script>
        <script type="text/javascript">

            /* global itowns,document,GuiTools*/
            const viewerDiv = document.getElementById('viewerDiv');

            itowns.proj4.defs(
                'EPSG:3946',
                '+proj=lcc +lat_1=45.25 +lat_2=46.75 +lat_0=46 +lon_0=3 +x_0=1700000 +y_0=5200000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');

            const menuGlobe = new GuiTools(itowns.viewer, 'menuDiv');

            const bbox = new itowns.BoundingBox(
                'EPSG:3946',
                1837816.94334, 1847692.32501,
                5170036.4587, 5178412.82698);

            // create default scene
            var scene = new itowns.Scene(viewerDiv, false, false);
            scene.initDefaultProviders();
            scene.scheduler.addProtocolProvider('3d-tiles', new itowns.ThreeDTiles_Provider());

            // add plane geometry layer
            const epsg3946TileLayer = {
                protocol: 'tile',
                id: 'lyon',
                update: itowns.updateTreeLayer,
                processNode: itowns.processTiledGeometryNode,
                nodeType: itowns.TileMesh,
                maxLevel: 6,
                /* tile process */
                initLevel0Nodes: itowns.initTiledGeometryLayer(),
                schemeTile: itowns.planeSchemeTile(bbox),
                cullingTest: itowns.planeCulling,
                initNewNode: itowns.initNewNode,
                mustSubdivide: itowns.planeSubdivisionControl,
                builder: new itowns.PlanarTileBuilder(),
            };

            scene.addLayer(epsg3946TileLayer);

            // add 3d-tiles layer
            /*const threeDTilesLayer = {
                protocol: '3d-tiles',
                id: 'test 3d-tiles',
                update: (context, layer, node) => itowns.processing.tree.update(itowns.processing.threeDTiles.update, context, layer, node),
                // nodeType: TileMesh,
                url: 'http://localhost:9090/getScene?city=lyon&layer=buildings&representations=lod1,lod2&weights=10,20&maxdepth=1',
                urlPrefix: 'http://localhost:9090/',
                initRootNodes: itowns.processing.threeDTiles.init,
                cullingTest: itowns.processing.threeDTiles.culling,
                preUpdate: (context, layer) => itowns.processing.threeDTiles.preUpdate(context, layer),
                mustSubdivide: itowns.processing.threeDTiles.subdivisionControl,
                // TODO: add a layer to be able to use Camera.layers feature
            };*/
            const threeDTilesLayer = {
                protocol: '3d-tiles',
                id: 'test 3d-tiles',
                update: itowns.updateTreeLayer,//(context, layer, node) => itowns.processing.tree.update(itowns.processing.threeDTiles.update, context, layer, node),
                processNode: itowns.process3DTilesNode,
                initLevel0Nodes: itowns.init3DTilesLayer,
                // nodeType: TileMesh,
                url: 'http://localhost:9090/getScene?city=lyon&layer=buildings&representations=lod1,lod2&weights=10,20&maxdepth=1',
                urlPrefix: 'http://localhost:9090/',
                initRootNodes: itowns.init3DTilesLayer,
                cullingTest: itowns.threeDTilesCulling,
                preUpdate: (context, layer) => itowns.pre3DTilesUpdate(context, layer),
                mustSubdivide: itowns.threeDTilesSubdivisionControl,
                // TODO: add a layer to be able to use Camera.layers feature
            };

            scene.addLayer(threeDTilesLayer);

            // debug
            const debugIdUpdate = function debugIdUpdate(context, layer, node) {
                var n = node.children.filter(n => n.layer == debugLayer.id);
                if (node.visible) {
                    if (n.length == 0) {
                        n = new itowns.THREE.BoxHelper(node.boundingVolume.box);
                        n.layer = debugLayer.id;
                        node.add(n);
                        n.update(node.boundingVolume.box);
                    } else {
                        n = n[0];
                    }
                    n.visible = true;
                }
                if (n.length > 0) {
                    n[0].visible = false;
                }
            };

            const debugLayer3dtiles = {
                id: '3dtile_bbox',
                update: debugIdUpdate,
            };
            scene.addLayer(debugLayer3dtiles, threeDTilesLayer.id);

            scene.addLayer({
                url       : "https://download.data.grandlyon.com/wms/grandlyon",
                protocol  : 'wms',
                version   : '1.3.0',
                id        : 'wms_imagery',
                name      : 'Ortho2009_vue_ensemble_16cm_CC46',
                style      : "",
                projection : "EPSG:3946",
                transparent : false,
                bbox      : [bbox.minCoordinate.x(), bbox.maxCoordinate.x(), bbox.minCoordinate.y(), bbox.maxCoordinate.y()],
                bbox_url  : "wsen",
                featureInfoMimeType : "",
                dateTime  : "",
                heightMapWidth : 256,
                waterMask      : false,
                updateStrategy: {
                    type: 0, /* see LayerUpdateStrategy.js */
                    options: {}
                },
                options: {
                    mimetype  : "image/jpeg"
                },
                update: itowns.updateLayeredMaterialNodeImagery,
            }, epsg3946TileLayer.id);
            scene.layersConfiguration.setLayerAttribute('wms_imagery', 'type', 'color');

            scene.addLayer({
                url       : "https://download.data.grandlyon.com/wms/grandlyon",
                protocol  : 'wms',
                version   : '1.3.0',
                id        : 'wms_elevation',
                name      : 'MNT2012_Altitude_10m_CC46',
                style      : "",
                projection : "EPSG:3946",
                transparent : false,
                bbox      : [bbox.minCoordinate.x(), bbox.maxCoordinate.x(), bbox.minCoordinate.y(), bbox.maxCoordinate.y()],
                bbox_url  : "wsen",
                featureInfoMimeType : "",
                dateTime  : "",
                heightMapWidth : 256,
                waterMask      : false,
                options: {
                    minmaxElevation: [0, 255],
                    mimetype  : "image/jpeg"
                },
                update: itowns.updateLayeredMaterialNodeElevation,
            }, epsg3946TileLayer.id);
            scene.layersConfiguration.setLayerAttribute('wms_elevation', 'type', 'elevation');

            scene.camera.camera3D.position.set(bbox.center().x(), bbox.center().y(), 20000);
            scene.camera.camera3D.near = 0.1;
            scene.camera.camera3D.far = 30000;
            scene.camera.update();
            scene.camera.camera3D.updateProjectionMatrix();

            var controls = scene.controls = new itowns.PlanarCameraControls(
                scene.camera.camera3D,
                scene.gfxEngine.renderer.domElement,
                scene.gfxEngine
            );
            controls.target.copy(scene.camera.camera3D.position);
            controls.target.z = 0;

            controls.minDistanceUp = 0;
            controls.maxDistanceUp = 30000;
            controls.minScale      = 0.000001;
            controls.maxScale      = 100.0;
            controls.minZenithAngle = 0;
            controls.maxZenithAngle = 1.57;
            controls.update();
            controls.addEventListener('change', (event) => {
                scene.notifyChange();
            });

            scene.notifyChange();

            itowns.debug = new Debug(scene);
            var debugLayer = itowns.addOBBLayer(epsg3946TileLayer, scene);
            itowns.debug.addGeometryVisibilityCheckbox(debugLayer, scene);
        </script>
    </body>
</html>
